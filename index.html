<html><head><base href="https://sethispr.github.io/fos">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="sa op calc">
    <meta name="keywords" content="silent assassin roblox">
    <meta name="author" content="sethispr">
    <meta property="og:title" content="fos beta, pure manual">
    <meta property="og:description" content="sa op calc test">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://sethispr.github.io/fos/">
    <meta property="og:image" content="https://sethispr.github.io/fos/favicon.ico">
    <meta name="theme-color" content="#000000">
    <link rel="canonical" href="https://sethispr.github.io/fos/">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <title>fos</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="icon" href="https://sethispr.github.io/fos/assets/izzi.ico"/>
    <style>
        /* Mobile-first styles */
        body {
            font-family: 'Lexend Deca', sans-serif;
            margin: 0;
            padding: 20px;
            background: #000000; /* AMOLED black background */
            color: #dcddde; /* Light text color */
            font-size: 18px; /* Increased from 16px */
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            cursor: default; /* Remove custom cursor */
            scrollbar-width: thin;
            scrollbar-color: #0c0c0c #000000;
        }

        .container {
            width: 95%;
            max-width: 100%;
            resize: vertical; /* Allow only vertical resize on mobile */
            overflow: visible;
            min-width: 300px;
            min-height: 400px;
            transition: all 0.3s ease;
            position: relative;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(26, 26, 26, 0.2);
            background: #000000;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 8px 8px 15px rgba(0, 0, 0, 0.6), -8px -8px 15px rgba(12, 12, 12, 0.1);
            margin: auto;
        }

        /* Remove container scrollbar-specific styles */
        .container::-webkit-scrollbar,
        .container::-webkit-scrollbar-track,
        .container::-webkit-scrollbar-thumb {
            display: none;
        }

        /* General scrollbar styles */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #000000;
            border-radius: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: #0c0c0c;
            border-radius: 8px;
            border: 2px solid #000000;
            transition: background 0.3s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #1a1a1a;
        }

        /* For Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: #0c0c0c #000000;
        }

        /* Button styles */
        button {
            padding: 10px 18px;
            font-size: 0.95rem;
            background: #000000;
            color: #dcddde;
            border: 1px solid #1a1a1a; /* Updated border color to match theme */
            cursor: pointer;
            font-family: 'Lexend Deca', sans-serif;
            font-weight: 600;
            text-transform: uppercase;
            transition: all 0.2s ease-in-out;
            border-radius: 8px;
        }

        button:hover {
            background: #0c0c0c;
            box-shadow: none;
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        /* Input-group styles */
        .calculator-section {
            resize: none; /* Remove resizing */
            overflow: visible;
            min-height: 200px;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group label {
            color: #72767d; /* Muted text color */
            font-size: 0.92rem;
            font-weight: 600;
        }

        .input-group input {
            font-size: 1rem;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            color: #dcddde;
            border: 1px solid rgba(26, 26, 26, 0.4);
            opacity: 0.7;
            transition: all 0.3s ease;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            backdrop-filter: blur(4px);
        }

        .input-group input:hover,
        .input-group input:focus {
            opacity: 1;
            background: rgba(12, 12, 12, 0.5);
            border-color: rgba(38, 38, 38, 0.6);
            outline: none;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            font-weight: bold;
        }

        /* Results section */
        .results-section {
            resize: none;
            overflow: visible;
            min-width: 250px;
            min-height: 200px;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
            background: #000000;
            padding: 20px;
            border: 1px solid #1a1a1a;
            border-radius: 16px;
            margin-top: 20px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .results-section .result-header h4 {
            margin: 0;
            color: #72767d;
            font-weight: normal;
        }

        .result-header button {
            padding: 8px 12px;
            font-size: 0.85rem;
            background: #000000;
            color: #dcddde;
            border: 1px solid #1a1a1a;
            cursor: pointer;
            font-family: 'Lexend Deca', sans-serif;
            font-weight: 600;
            text-transform: uppercase;
            transition: all 0.2s ease-in-out;
            border-radius: 8px;
        }

        .result-header button:hover {
            background: #0c0c0c;
            box-shadow: none;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            margin: 5px 0;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .result-item:hover {
            background: rgba(12, 12, 12, 0.4);
            transform: translateX(5px);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            color: #72767d;
            position: relative;
            cursor: pointer;
        }

        .result-label[data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            background-color: rgba(0, 0, 0, 0.85);
            color: #dcddde;
            padding: 5px 10px;
            border-radius: 5px;
            white-space: nowrap;
            font-size: 14px;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 100;
            margin-top: 5px;
        }

        .result-label:hover::after {
            opacity: 1;
        }

        .result-value {
            color: #72767d;
            font-weight: 600;
        }

        /* Round statistics */
        .stat-line {
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 12px;
            background: #000000;
            opacity: 0.7;
            transition: all 0.3s ease;
            border: 1px solid #1a1a1a;
            position: relative;
            overflow: visible;
        }

        .stat-line:hover {
            opacity: 1;
            background: #0c0c0c;
            border-color: #262626;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2), 0 0 0 1px #262626;
        }

        .stat-value {
            font-weight: 600;
            outline: none;
            border: none;
            background: transparent;
            transition: all 0.3s ease;
            color: #dcddde;
            cursor: text;
            min-width: 20px;
            display: inline-block;
        }

        .stat-value:focus {
            outline: none;
            box-shadow: none;
        }

        .stat-line:focus-within {
            opacity: 1;
            background: #0c0c0c;
            border-color: #262626;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2), 0 0 0 1px #262626;
        }

        /* Device selection */
        .device-selection {
            margin-top: 30px;
            margin-bottom: 20px;
        }

        .device-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .device-option {
            flex: 1;
            min-width: 100px;
            font-size: 1.1rem; /* Increased from base */
            background: #000000;
            padding: 12px;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.7;
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .device-option:hover,
        .device-option.selected {
            background: #0c0c0c;
            border-color: #262626;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .device-option.selected {
            opacity: 1;
            background: #0c0c0c;
            border: 1px solid #262626;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
            transform: translateY(1px);
        }

        .device-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #72767d;
        }

        .device-label i {
            font-size: 1.2em;
            color: #888;
        }

        /* Formatted stats */
        .formatted-output {
            margin-top: 20px;
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stats-header h4 {
            margin: 0;
            color: #72767d;
            font-weight: normal;
        }

        .formatted-output #formattedStats {
            white-space: pre-line;
            word-wrap: break-word;
            color: #72767d;
        }

        /* Tutorial Overlay Styles */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
        }

        .tutorial-box {
            position: fixed;
            background: #000000;
            border: 1px solid #1a1a1a;
            border-radius: 0;
            border-top-left-radius: 12px;
            border-bottom-right-radius: 12px;
            padding: 20px;
            color: #dcddde;
            max-width: 300px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            animation: tutorialFadeIn 0.3s ease-out;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes tutorialFadeIn {
            0% {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Remove pointing-related styles */
        .tutorial-box.pointing-right::after,
        .tutorial-box.pointing-left::after,
        .tutorial-box.pointing-down::after,
        .tutorial-box.pointing-up::after {
            display: none;
        }

        .highlight-element {
            position: relative;
            z-index: 1002;
            box-shadow: 0 0 0 2px #dcddde;
            border-radius: 8px;
        }

        .tutorial-box button {
            padding: 8px 12px;
            border: none;
            background: #0c0c0c;
            color: #dcddde;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .tutorial-box button:hover {
            background: #1a1a1a;
        }

        .tutorial-box .tutorial-prev,
        .tutorial-box .tutorial-next,
        .tutorial-box .tutorial-complete {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tutorial-box .tutorial-skip {
            font-size: 14px;
            padding: 0 12px;
        }

        .tutorial-box i {
            font-size: 16px;
        }

        /* Error Popup Styles */
        .error-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: #1a1a1a;
            color: #dcddde;
            padding: 20px 30px;
            border: 1px solid #262626;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
            min-width: 300px;
            max-width: 90vw;
        }

        .error-popup.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .error-popup .error-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .error-popup .error-icon {
            font-size: 24px;
            color: #ff4d4d;
        }

        .error-popup .error-message {
            flex: 1;
        }

        .error-popup .close-error {
            background: #0c0c0c;
            border: none;
            color: #dcddde;
            font-size: 16px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s ease;
        }

        .error-popup .close-error:hover {
            background: #1a1a1a;
        }

        .error-popup .close-error i {
            font-size: 14px;
        }

        /* Custom Cursor Styles */
        .custom-cursor {
            display: none; /* Removed custom cursor */
        }

        /* Scroll Up Button Styles */
        #scrollUpButton {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: #000000;
            border: 1px solid #1a1a1a;
            border-radius: 50%;
            box-shadow: 8px 8px 15px rgba(0, 0, 0, 0.6), -8px -8px 15px rgba(12, 12, 12, 0.1);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
            z-index: 9999;
            backdrop-filter: blur(4px);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #scrollUpButton.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        #scrollUpButton.hide {
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
        }

        #scrollUpButton:hover {
            background: #0c0c0c;
            transform: translateY(0) scale(1.1);
            box-shadow: 10px 10px 20px rgba(0,0,0,0.6), -10px -10px 20px rgba(12,12,12,0.1);
        }

        /* SVG Icon for Scroll Up Button */
        #scrollUpButton svg {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: #dcddde;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* Graphs Section Styles */
        .graphs-section {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            padding: 20px;
            margin-top: 20px;
            border-radius: 16px;
            background: transparent;
        }

        .graphs-section.show {
            display: block;
            opacity: 1;
        }

        .graphs-section canvas {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            display: block;
        }

        /* Tooltip Styles */
        #tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.85);
            color: #dcddde;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10000;
            white-space: nowrap;
        }

        /* Mobile-first enhancements */
        @media (min-width: 769px) {
            .calculator-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 20px;
                padding: 20px;
            }

            .button-group {
                gap: 15px;
            }

            .input-group input {
                padding: 12px;
            }

            .graphs-section canvas {
                max-width: 600px;
            }

            /* Additional styles for larger screens */
        }

        @media (max-width: 480px) {
            body {
                font-size: 16px;
            }

            .input-group input {
                font-size: 0.85rem;
            }

            .calculator-grid {
                gap: 10px;
            }

            .device-options {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .tutorial-box {
                max-width: 90%;
                padding: 15px;
            }

            .tutorial-box .tutorial-skip {
                padding: 0 8px;
            }

            .result-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .result-value {
                margin-top: 5px;
            }

            .button-group {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* Graph Styling */
        .graphs-section {
            background: #000000;
            border: none;
            box-shadow: none;
        }

        /* Additional mobile-first adjustments can be added here */

        /* Add smooth scrolling to the page */
        html {
            scroll-behavior: smooth;
        }

        /* Add smooth animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .container {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="button-group">
            <button id="resetButton"><i class="fas fa-redo"></i> Reset</button>
            <button id="showTutorial"><i class="fas fa-question-circle"></i> Tutorial</button>
            <button id="copyButton"><i class="fas fa-copy"></i> Copy</button>
        </div>
        <div id="output" contenteditable="false"></div>
        <div class="calculator-section">
            <div class="calculator-grid">
                <div class="input-group">
                    <label for="l_va">Level A</label>
                    <input type="number" id="l_va" placeholder="Lvl A" min="0" step="1">
                </div>
                <div class="input-group">
                    <label for="X_pa">XP A</label>
                    <input type="number" id="X_pa" placeholder="XP A" min="0" step="1">
                </div>
                <div class="input-group">
                    <label for="l_vb">Level B</label>
                    <input type="number" id="l_vb" placeholder="Lvl B" min="0" step="1">
                </div>
                <div class="input-group">
                    <label for="X_pb">XP B</label>
                    <input type="number" id="X_pb" placeholder="XP B" min="0" step="1">
                </div>
                <div class="input-group">
                    <label for="sdi">SDI</label>
                    <input type="number" id="sdi" value="1" step="0.1" min="0">
                </div>
            </div>
            <div class="results-section">
                <div class="result-header">
                    <h4>Performance Stats</h4>
                    <button id="toggleGraphButton"><i class="fas fa-chart-pie"></i> Show Graph</button>
                </div>
                <div class="result-item">
                    <span class="result-label" data-tooltip="OP = 529 / 20 * √(TP + SP)">Overall Performance (OP)</span>
                    <span class="result-value" id="op_result">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label" data-tooltip="TP = (2 * R_ad * (86 * GO + S_mb * 32 * AD) + S_di * 59 * XPR * R_ad) / (165 * R_ad)">Tactical Performance (TP)</span>
                    <span class="result-value" id="tp_result">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label" data-tooltip="SP = (13 / R_ad) * (S_mb * (9 * F + 15 * i + 40 * w + 25 * I + 100 * e_p) + S_ma * 15 * s)">Special Performance (SP)</span>
                    <span class="result-value" id="sp_result">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label" data-tooltip="R_g = max(0, R_ad - E - t - e_p - s - w)">Guard Rounds (R_g)</span>
                    <span class="result-value" id="rg_result">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label" data-tooltip="GO = 46 * ((S_di * 5 * S + S_ma * 3 * P) / max(1, R_g))">Guard Objective Score (GO)</span>
                    <span class="result-value" id="gos_result">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label" data-tooltip="AD = D / max(1, (R_ad - (E + t + e_p)))">Average Damage (AD)</span>
                    <span class="result-value" id="ad_result">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label" data-tooltip="XPR = X_T / max(1, R_ad)">XP per Round (XPR)</span>
                    <span class="result-value" id="xpr_result">-</span>
                </div>
            </div>
            <!-- Graphs Section -->
            <div class="graphs-section">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>
        <div id="additionalSection" class="calculator-section">
            <div class="device-selection" style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px;">Primary Gaming Device</label>
                <div class="device-options">
                    <button class="device-option" data-value="pc">
                        <i class="fas fa-desktop"></i> PC/Laptop
                    </button>
                    <button class="device-option" data-value="mobile">
                        <i class="fas fa-mobile-alt"></i> Mobile
                    </button>
                    <button class="device-option" data-value="tablet">
                        <i class="fas fa-tablet-alt"></i> Tablet
                    </button>
                    <button class="device-option" data-value="console">
                        <i class="fas fa-gamepad"></i> Console
                    </button>
                </div>
            </div>
            <div class="formatted-output">
                <div class="stats-header">
                    <h4>Stats Summary</h4>
                    <button id="copyFormatted"><i class="fas fa-copy"></i> Copy</button>
                </div>
                <div id="formattedStats"></div>
            </div>
        </div>
        <div class="github-link" style="display: none;"></div>
    </div>
    <!-- Scroll Up Button -->
    <button id="scrollUpButton" aria-label="Scroll to top">
        <svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
            <polyline points="5 12 10 7 15 12" />
            <line x1="10" y1="7" x2="10" y2="17" />
        </svg>
    </button>
    <!-- Error Popup -->
    <div class="error-popup" id="errorPopup">
        <div class="error-content">
            <i class="fas fa-exclamation-triangle error-icon"></i>
            <div class="error-message" id="errorMessage">An error has occurred.</div>
            <button class="close-error" id="closeError"><i class="fas fa-keyboard"></i> ESC</button>
        </div>
    </div>
    <!-- Custom Cursor -->
    <div class="custom-cursor" id="customCursor"></div>
    <!-- Tooltip -->
    <div id="tooltip"></div>
    <script>
        const FIXED_LABELS = [
            "Rounds played",
            "Targets assassinated", 
            "Escapes",
            "Targets protected",
            "Damage dealt",
            "Final shots",
            "Target survivals",
            "Free for all kills",
            "Free for all wins",
            "Infecteds killed",
            "Infection survivals",
            "Infections",
            "Epidemics"
        ];

        let currentScreenshot = 'A';
        let screenshotAData = {};
        let screenshotBData = {};

        const copyButton = document.getElementById('copyButton');
        const resetButton = document.getElementById('resetButton');
        const output = document.getElementById('output');
        const errorPopup = document.getElementById('errorPopup');
        const errorMessage = document.getElementById('errorMessage');
        const closeError = document.getElementById('closeError');
        const customCursor = document.getElementById('customCursor');
        const scrollUpButton = document.getElementById('scrollUpButton');
        const tooltip = document.getElementById('tooltip');
        const toggleGraphButton = document.getElementById('toggleGraphButton');

        let performanceChart; // Global Chart.js instance
        let graphVisible = false; // Track graph visibility

        window.addEventListener('load', () => {
            // Focus on first stat value (rounds played)
            const firstStatValue = document.querySelector('.stat-value');
            if (firstStatValue) {
                firstStatValue.focus();
                setCaretAtEnd(firstStatValue);
            }
            
            const savedDevice = localStorage.getItem('selectedDevice') || 'pc';
            const savedDeviceButton = document.querySelector(`button[data-value="${savedDevice}"]`);
            if (savedDeviceButton) {
                savedDeviceButton.classList.add('selected');
            }
            
            // Set default rounds played to 224
            const roundsPlayedValue = document.querySelector('.stat-line:first-child .stat-value');
            if (roundsPlayedValue) {
                roundsPlayedValue.textContent = '224';
                calculateOP(); // Trigger initial calculation
            }

            copyButton.disabled = false;
            addExperienceInputListeners();

            if (!output.innerHTML) {
                const emptyStats = FIXED_LABELS.map(label => `
                    <div class="stat-line">
                        <span class="stat-label">${label}</span>
                        <span class="stat-value" contenteditable="true"></span>
                    </div>
                `).join('');
                output.innerHTML = emptyStats;
                
                // Add input listeners to the newly created stat values
                document.querySelectorAll('.stat-value').forEach(statValue => {
                    statValue.addEventListener('input', () => {
                        validateStatInputs();
                        validateNumericStatInputs(statValue);
                        calculateOP();
                    });

                    // Prevent non-numeric input
                    statValue.addEventListener('keypress', (e) => {
                        const char = String.fromCharCode(e.which);
                        if (!/[0-9]/.test(char)) {
                            e.preventDefault();
                            showErrorPopup('Please enter only numeric values.');
                        }
                    });
                });
            }

            document.getElementById('showTutorial').addEventListener('click', () => {
                localStorage.removeItem('tutorialComplete');
                new Tutorial(tutorialSteps);
            });

            // Close error popup when close button is clicked
            closeError.addEventListener('click', () => {
                hideErrorPopup();
            });

            // Hide error popup when clicking outside the error content
            errorPopup.addEventListener('click', (e) => {
                if (e.target === errorPopup) {
                    hideErrorPopup();
                }
            });

            // Hide error popup when pressing ESC key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && errorPopup.classList.contains('active')) {
                    hideErrorPopup();
                }
            });

            // Update custom cursor position
            document.addEventListener('mousemove', (e) => {
                customCursor.style.transform = `translate(${e.clientX}px, ${e.clientY}px) translate(-50%, -50%)`;
            });

            // Change cursor style on hover over interactive elements
            const interactiveElements = document.querySelectorAll('button, a, .device-option, input');
            interactiveElements.forEach(elem => {
                elem.addEventListener('mouseenter', () => {
                    customCursor.classList.add('hovering');
                });
                elem.addEventListener('mouseleave', () => {
                    customCursor.classList.remove('hovering');
                });
            });

            // Scroll Up Button Logic
            window.addEventListener('scroll', () => {
                if (window.scrollY > 300) {
                    scrollUpButton.classList.add('show');
                    scrollUpButton.classList.remove('hide');
                } else {
                    scrollUpButton.classList.add('hide');
                    scrollUpButton.classList.remove('show');
                }
            });

            scrollUpButton.addEventListener('click', () => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });

            // Toggle Graph Button Logic
            toggleGraphButton.addEventListener('click', () => {
                const graphSection = document.querySelector('.graphs-section');
                if (!graphVisible) {
                    graphSection.classList.add('show');
                    toggleGraphButton.innerHTML = '<i class="fas fa-chart-pie"></i> Hide Graph';
                    graphVisible = true;
                    
                    // Scroll to graph section
                    graphSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Initialize or update the graph
                    updateGraphs();
                } else {
                    graphSection.classList.remove('show');
                    toggleGraphButton.innerHTML = '<i class="fas fa-chart-pie"></i> Show Graph';
                    graphVisible = false;
                }
            });
        });

        // Add event listener for Level A input
        document.getElementById('l_va').addEventListener('input', function() {
            const levelA = parseFloat(this.value) || 0;
            const levelBInput = document.getElementById('l_vb');
            if (levelA > 0) {
                // Set Level B to Level A + 1
                levelBInput.value = (levelA + 1).toString();
            }
            // Trigger OP calculation
            calculateOP();
        });

        output.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const currentLine = e.target.closest('.stat-line');
                const nextLine = currentLine.nextElementSibling;
                
                if (nextLine) {
                    const nextInput = nextLine.querySelector('.stat-value');
                    if (nextInput) {
                        nextInput.focus();
                        setCaretAtEnd(nextInput);
                    }
                } else {
                    // If it's the last stat field (epidemics), move to l_va input
                    const l_va = document.getElementById('l_va');
                    l_va.focus();
                    l_va.select(); // Select all text instead of just focusing
                }
            }
            
            // Add backspace navigation
            if (e.key === 'Backspace' && e.target.textContent === '') {
                e.preventDefault();
                const currentLine = e.target.closest('.stat-line');
                const previousLine = currentLine.previousElementSibling;
                
                if (previousLine) {
                    const previousInput = previousLine.querySelector('.stat-value');
                    if (previousInput) {
                        previousInput.focus();
                        setCaretAtEnd(previousInput);
                    }
                }
            }
        });

        // Update experience input navigation
        ['l_va', 'X_pa', 'l_vb', 'X_pb'].forEach((id, index, arr) => {
            document.getElementById(id).addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (index < arr.length - 1) {
                        const nextInput = document.getElementById(arr[index + 1]);
                        nextInput.focus();
                        nextInput.select(); // Select all text
                    } else {
                        // Move to SDI if it's the last XP field
                        const sdi = document.getElementById('sdi');
                        sdi.focus();
                        sdi.select(); // Select all text
                    }
                }
            });
        });

        // Improve backspace navigation for experience inputs
        ['X_pb', 'l_vb', 'X_pa', 'l_va'].forEach((id, index, arr) => {
            document.getElementById(id).addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && e.target.value === '') {
                    e.preventDefault();
                    if (index < arr.length - 1) {
                        const prevInput = document.getElementById(arr[index + 1]);
                        prevInput.focus();
                        prevInput.select(); // Select all text
                    }
                }
            });
        });

        function cleanText(text) {
            const valueMap = new Map();
            text.split('\n').forEach(line => {
                const matches = line.match(/([a-zA-Z\s]+)[:\s]+([0-9,\.]+)/);
                if (matches) {
                    const [_, label, value] = matches;
                    const cleanLabel = label.trim().toLowerCase();
                    const cleanValue = value.replace(/[^\d]/g, '');
                    valueMap.set(cleanLabel, cleanValue);
                }
            });

            if (valueMap.size === 0) {
                text.split('\n').forEach(line => {
                    const matches = line.match(/([a-zA-Z\s]+)\s*(\d[\d,\.]*)/);
                    if (matches) {
                        const [_, label, value] = matches;
                        const cleanLabel = label.trim().toLowerCase();
                        const cleanValue = value.replace(/[^\d]/g, '');
                        valueMap.set(cleanLabel, cleanValue);
                    }
                });
            }

            return FIXED_LABELS.map(label => {
                const value = valueMap.get(label.toLowerCase()) || '0';
                return `${label}: ${value}`;
            }).join('\n');
        }

        function addExperienceInputListeners() {
            // Listen for experience input changes
            const expInputs = ['l_va', 'X_pa', 'l_vb', 'X_pb', 'sdi'];
            expInputs.forEach(id => {
                document.getElementById(id).addEventListener('input', () => {
                    validateExperienceInputs();
                    validateNumericInputs(id);
                    calculateOP();
                });

                // Prevent non-numeric input
                document.getElementById(id).addEventListener('keypress', (e) => {
                    const char = String.fromCharCode(e.which);
                    if (!/[0-9.\-]/.test(char)) {
                        e.preventDefault();
                        showErrorPopup('Please enter only numeric values.');
                    }
                });
            });
        }

        window.addEventListener('load', () => {
            // Already handled above
        });

        output.addEventListener('input', (e) => {
            if (e.target.classList.contains('stat-value')) {
                validateStatInputs();
                // Validate input is a number
                const value = e.target.textContent;
                if (value && !/^\d+$/.test(value)) {
                    e.target.classList.add('error');
                    e.target.setAttribute('title', 'Please enter only numbers');
                    showErrorPopup('Please enter only numeric values.');
                } else {
                    e.target.classList.remove('error');
                    e.target.removeAttribute('title');
                }
                // Immediately calculate OP when any stat value changes
                calculateOP();
            }
        });

        resetButton.addEventListener('click', () => {
            // Reset all stat values
            document.querySelectorAll('.stat-value').forEach(value => {
                value.textContent = value.closest('.stat-line').querySelector('.stat-label').textContent === 'Rounds played' ? '224' : '';
                value.classList.remove('error');
                value.removeAttribute('title');
            });
            
            // Reset level and XP inputs including lvB
            ['l_va', 'X_pa', 'l_vb', 'X_pb'].forEach(id => {
                document.getElementById(id).value = '';
                document.getElementById(id).classList.remove('error');
                document.getElementById(id).removeAttribute('title');
            });
            
            // Reset SDI to default
            document.getElementById('sdi').value = '1';
            document.getElementById('sdi').classList.remove('error');
            document.getElementById('sdi').removeAttribute('title');
            
            // Reset device to PC/Laptop or last saved
            const savedDevice = localStorage.getItem('selectedDevice') || 'pc';
            document.querySelectorAll('.device-option').forEach(btn => btn.classList.remove('selected'));
            const savedDeviceButton = document.querySelector(`button[data-value="${savedDevice}"]`);
            if (savedDeviceButton) {
                savedDeviceButton.classList.add('selected');
            }
            
            // Reset toggleGraphButton text if graph is visible
            if (graphVisible) {
                toggleGraphButton.innerHTML = '<i class="fas fa-chart-pie"></i> Show Graph';
                graphVisible = false;
                document.querySelector('.graphs-section').classList.remove('show');
            }
            
            // Recalculate
            calculateOP();
        });

        copyButton.addEventListener('click', () => {
            const lines = Array.from(output.querySelectorAll('.stat-line'))
                .map(line => {
                    const label = line.querySelector('.stat-label').textContent;
                    const value = line.querySelector('.stat-value').textContent.replace(/[^\d]/g, '');
                    return `${label} ${value}`;
                })
                .join('\n');

            navigator.clipboard.writeText(lines).then(() => {
                copyButton.innerHTML = '<i class="fas fa-check"></i> Copied!';
                setTimeout(() => {
                    copyButton.innerHTML = '<i class="fas fa-copy"></i> Copy';
                }, 2000);
            }, (err) => {
                console.error('Error copying text: ', err);
                showErrorPopup('Failed to copy to clipboard.');
            });
        });

        function calculateXPSum(level) {
            let sum = 0;
            for(let n = 1; n <= level; n++) {
                sum += Math.floor((n-1) * (2.46 * Math.pow(1.02, n)) * 10) * 10;
            }
            return sum;
        }

        function validateExperienceInputs() {
            const l_va = parseFloat(document.getElementById('l_va').value);
            const l_vb = parseFloat(document.getElementById('l_vb').value);

            if (!isNaN(l_vb) && !isNaN(l_va) && l_vb < l_va) {
                showErrorPopup('Level B cannot be smaller than Level A.');
                document.getElementById('l_vb').classList.add('error');
                document.getElementById('l_vb').setAttribute('title', 'Level B must be greater than or equal to Level A');
            } else {
                document.getElementById('l_vb').classList.remove('error');
                document.getElementById('l_vb').removeAttribute('title');
            }
        }

        function validateNumericInputs(id) {
            const input = document.getElementById(id);
            const value = parseFloat(input.value);
            if (isNaN(value)) {
                input.classList.add('error');
                input.setAttribute('title', 'Please enter only numeric values.');
            } else {
                input.classList.remove('error');
                input.removeAttribute('title');
            }
        }

        function validateNumericStatInputs(statValue) {
            const value = parseInt(statValue.textContent);
            if (isNaN(value)) {
                statValue.classList.add('error');
                statValue.setAttribute('title', 'Please enter only numeric values.');
            } else {
                statValue.classList.remove('error');
                statValue.removeAttribute('title');
            }
        }

        function validateStatInputs() {
            const statLabel2 = document.querySelector('#output .stat-label:nth-of-type(2)');
            const statLabel3 = document.querySelector('#output .stat-label:nth-of-type(3)');

            const targetsAssassinated = statLabel2 ? parseInt(statLabel2.parentElement.querySelector('.stat-value').textContent) || 0 : 0;
            const escapes = statLabel3 ? parseInt(statLabel3.parentElement.querySelector('.stat-value').textContent) || 0 : 0;

            const allStatValues = {};
            document.querySelectorAll('#output .stat-line').forEach(line => {
                const label = line.querySelector('.stat-label').textContent;
                const value = parseInt(line.querySelector('.stat-value').textContent) || 0;
                allStatValues[label] = value;
            });

            if (allStatValues['Targets assassinated'] < allStatValues['Escapes']) {
                showErrorPopup('Targets assassinated cannot be lower than Escapes.');
                document.querySelectorAll('#output .stat-line').forEach(line => {
                    const label = line.querySelector('.stat-label').textContent;
                    if (label === 'Targets assassinated' || label === 'Escapes') {
                        line.querySelector('.stat-value').classList.add('error');
                        line.querySelector('.stat-value').setAttribute('title', 'Cannot be lower than Escapes.');
                    }
                });
            } else {
                document.querySelectorAll('#output .stat-line').forEach(line => {
                    const label = line.querySelector('.stat-label').textContent;
                    if (label === 'Targets assassinated' || label === 'Escapes') {
                        line.querySelector('.stat-value').classList.remove('error');
                        line.querySelector('.stat-value').removeAttribute('title');
                    }
                });
            }
        }

        function calculateOP() {
            try {
                const l_va = parseFloat(document.getElementById('l_va').value) || 0;
                const X_pa = parseFloat(document.getElementById('X_pa').value) || 0;
                const l_vb = parseFloat(document.getElementById('l_vb').value) || 0;
                const X_pb = parseFloat(document.getElementById('X_pb').value) || 0;
                const S_di = parseFloat(document.getElementById('sdi').value) || 1;

                // Get all stat values first
                const statValues = {};
                document.querySelectorAll('#output .stat-line').forEach(line => {
                    const label = line.querySelector('.stat-label').textContent;
                    const value = parseInt(line.querySelector('.stat-value').textContent) || 0;
                    statValues[label] = value;
                });

                // Calculate basic stats even if XP/level data is missing
                const R = statValues['Rounds played'] || 0;
                const E = statValues['Escapes'] || 0;
                const t = statValues['Target survivals'] || 0;
                const e_p = statValues['Epidemics'] || 0;
                const s = statValues['Infection survivals'] || 0;
                const w = statValues['Free for all wins'] || 0;
                const A = statValues['Targets assassinated'] || 0;

                // Validate Targets assassinated >= Escapes
                if (A < E) {
                    showErrorPopup('Targets assassinated cannot be lower than Escapes.');
                    document.querySelectorAll('#output .stat-line').forEach(line => {
                        const label = line.querySelector('.stat-label').textContent;
                        if (label === 'Targets assassinated' || label === 'Escapes') {
                            line.querySelector('.stat-value').classList.add('error');
                            line.querySelector('.stat-value').setAttribute('title', 'Cannot be lower than Escapes.');
                        }
                    });
                    ['op_result', 'tp_result', 'sp_result', 'gos_result', 'ad_result', 'xpr_result'].forEach(id => {
                        document.getElementById(id).textContent = '-';
                    });
                    updateFormattedStats();
                    updateGraphs(); // Update graphs with reset values
                    return;
                } else {
                    document.querySelectorAll('#output .stat-line').forEach(line => {
                        const label = line.querySelector('.stat-label').textContent;
                        if (label === 'Targets assassinated' || label === 'Escapes') {
                            line.querySelector('.stat-value').classList.remove('error');
                            line.querySelector('.stat-value').removeAttribute('title');
                        }
                    });
                }

                // Always calculate R_ad and R_g
                const R_ad = Math.max(0, R - E);
                const R_g = Math.max(0, R_ad - E - t - e_p - s - w);

                // Update R_g result
                document.getElementById('rg_result').textContent = R_g.toFixed(0);

                // Only proceed with full calculations if we have necessary base data
                if (R_ad <= 0) {
                    ['op_result', 'tp_result', 'sp_result', 'gos_result', 'ad_result', 'xpr_result'].forEach(id => {
                        document.getElementById(id).textContent = '-';
                    });
                    updateFormattedStats();
                    updateGraphs(); // Update graphs with reset values
                    return;
                }

                const S = statValues['Final shots'] || 0;
                const P = statValues['Targets protected'] || 0;
                const D = statValues['Damage dealt'] || 0;
                const F = statValues['Free for all kills'] || 0;
                const i = statValues['Infecteds killed'] || 0;
                const I = statValues['Infections'] || 0;

                // Calculate S_ma and S_mb
                const S_ma = S_di < 1 ? 1 + ((2/3 * (S_di - 1) + 1)) - 1 : (2/3 * (S_di - 1) + 1);
                const S_mb = S_di < 1 ? 1 + ((4/3 * (S_di - 1) + 1)) - 1 : (4/3 * (S_di - 1) + 1);

                // Calculate g_os and D_avg even with partial data
                const g_os = 46 * ((S_di * 5 * S + S_ma * 3 * P) / Math.max(1, R_g));
                const D_avg = D / Math.max(1, (R_ad - (E + t + e_p)));

                // Calculate XP related stats if XP data is available
                let x_pr = 0;
                if (l_va || l_vb || X_pa || X_pb) {
                    const X_Ta = X_pa + calculateXPSum(l_va);
                    const X_Tb = X_pb + calculateXPSum(l_vb);
                    const X_T = Math.abs(X_Tb - X_Ta);
                    x_pr = X_T / Math.max(1, R_ad);
                }

                // Calculate final stats
                const z = (13 / Math.max(1, R_ad)) * 
                    (S_mb * (9 * F + 15 * i + 40 * w + 25 * I + 100 * e_p) + S_ma * 15 * s);

                const t_p = ((2 * R_ad * (86 * g_os + S_mb * 32 * D_avg) + S_di * 59 * x_pr * R_ad) / (165 * R_ad));
                const o_p = (529 / 20) * Math.sqrt(t_p + z);

                // Update results with proper error handling
                const updateResult = (id, value, decimals = 3) => {
                    const element = document.getElementById(id);
                    try {
                        if (isNaN(value) || !isFinite(value)) {
                            element.textContent = '-';
                            return;
                        }
                        element.textContent = decimals === 0 ? Math.round(value) : value.toFixed(decimals);
                        element.classList.remove('error');
                        element.removeAttribute('title');
                    } catch (err) {
                        element.textContent = '-';
                        element.classList.add('error');
                        element.setAttribute('title', err.message);
                        showErrorPopup('Calculation error: ' + err.message);
                    }
                };

                updateResult('op_result', o_p);
                updateResult('tp_result', t_p);
                updateResult('sp_result', z);
                updateResult('gos_result', g_os);
                updateResult('ad_result', D_avg);
                updateResult('xpr_result', x_pr);

                updateFormattedStats();
                if (graphVisible) {
                    updateGraphs();
                }
            } catch (error) {
                console.error('Calculation error:', error);
                ['op_result', 'tp_result', 'sp_result', 'rg_result', 'gos_result', 'ad_result', 'xpr_result'].forEach(id => {
                    const element = document.getElementById(id);
                    element.textContent = '-';
                    element.classList.add('error');
                    element.setAttribute('title', error.message || 'Invalid calculation');
                });
                document.getElementById('formattedStats').textContent = 'Calculating...';
                showErrorPopup('Calculation error: ' + (error.message || 'Invalid calculation'));
                updateGraphs(); // Update graphs with reset values
            }
        }

        // Improved: Automatically update formatted stats when selecting a gaming device
        document.querySelectorAll('.device-option').forEach(button => {
            button.addEventListener('click', function () {
                document.querySelectorAll('.device-option').forEach(btn => btn.classList.remove('selected'));
                this.classList.add('selected');
                const selectedDevice = this.getAttribute('data-value');
                localStorage.setItem('selectedDevice', selectedDevice);
                calculateOP();
            });
        });

        // Improved: Update formatted stats to reflect the updated OP with boosts
        function updateFormattedStats() {
            const op = parseFloat(document.getElementById('op_result').textContent) || 0;
            const tp = parseFloat(document.getElementById('tp_result').textContent) || 0;
            const sp = parseFloat(document.getElementById('sp_result').textContent) || 0;
            const go = parseFloat(document.getElementById('gos_result').textContent) || 0;
            const ad = parseFloat(document.getElementById('ad_result').textContent) || 0;
            const xpr = parseFloat(document.getElementById('xpr_result').textContent) || 0;
            const sdi = parseFloat(document.getElementById('sdi').value) || 1;

            const selectedDevice = document.querySelector('.device-option.selected') ? document.querySelector('.device-option.selected').getAttribute('data-value') : 'pc';
            let boostedOP = op;

            // Apply device boost
            if (selectedDevice === 'pc') boostedOP *= 1.0; 
            if (selectedDevice === 'mobile') boostedOP *= 1.075;
            if (selectedDevice === 'tablet') boostedOP *= 1.05;
            if (selectedDevice === 'console') boostedOP *= 1.10; 
            
            // Determine Division
            let division = '';
            if (boostedOP >= 975) division = "Kugelblitz (S)";
            else if (boostedOP >= 935) division = "Radiance (A+)";
            else if (boostedOP >= 870) division = "Firestorm (A)";
            else if (boostedOP >= 820) division = "Flashover (A-)";
            else if (boostedOP >= 765) division = "Magnesium (B+)";
            else if (boostedOP >= 705) division = "Thermite (B)";
            else if (boostedOP >= 635) division = "Propane (C)";
            else if (boostedOP >= 560) division = "Wood (D)";
            else division = "Ember (E)";

            // Render formatted text with proper line breaks
            const formattedText = 
`OP = ${Math.round(boostedOP)}
TP = ${Math.round(tp)}, SP = ${Math.round(sp)}
[GO = ${Math.round(go)}], [AD = ${Math.round(ad)}], [XPR = ${Math.round(xpr)}]
SDI = ${sdi.toFixed(4)}

Division: ${division}
Source: website`;

            document.getElementById('formattedStats').textContent = formattedText;
        }

        const existingCalculateOP = calculateOP;
        calculateOP = function() {
            existingCalculateOP();
            updateFormattedStats();
        };

        document.getElementById('copyFormatted').addEventListener('click', function() {
            const stats = document.getElementById('formattedStats').textContent;
            navigator.clipboard.writeText(stats).then(() => {
                this.innerHTML = '<i class="fas fa-check"></i> Copied!';
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-copy"></i> Copy';
                }, 2000);
            }).catch(() => {
                showErrorPopup('Failed to copy formatted stats.');
            });
        });

        function updateStatVisibility() {
            document.querySelectorAll('.stat-line').forEach(line => {
                const value = line.querySelector('.stat-value').textContent;
                if (value && value.trim() !== '') {
                    line.classList.add('has-value');
                } else {
                    line.classList.remove('has-value');
                }
            });
        }

        // Tutorial Implementation
        const tutorialSteps = [
            {
                target: '.stat-line:first-child',
                content: 'Start by entering your SA statistics. The first field is for Rounds played. (You can use the ENTER key to go to next field)',
                position: 'right'
            },
            {
                target: '#l_va',
                content: 'Enter your starting level (Level A) here.',
                position: 'right'
            },
            {
                target: '#X_pa',
                content: 'Input your starting XP (XP A) here.',
                position: 'right'
            },
            {
                target: '.device-options',
                content: 'Select your gaming device to get accurate performance calculations with platform bonuses.',
                position: 'right'
            },
            {
                target: '.results-section',
                content: 'Your performance stats will appear here. The Overall Performance (OP) determines your division ranking.',
                position: 'left'
            },
            {
                target: '#formattedStats',
                content: 'Find your complete stats summary here, ready to copy and share to.',
                position: 'right'
            },
            {
                target: '.graphs-section',
                content: 'View your performance through a graph. (Will be improved soon)',
                position: 'bottom'
            }
        ];

        class Tutorial {
            constructor(steps) {
                this.steps = steps;
                this.currentStep = 0;
                this.overlay = null;
                this.box = null;
                this.init();
            }

            init() {
                if (localStorage.getItem('tutorialComplete') === 'true') {
                    return;
                }

                this.createOverlay();
                this.showStep(0);

                // Add keyboard navigation event listener
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.complete();
                    } else if (e.key === 'ArrowRight') {
                        if (this.currentStep < this.steps.length - 1) {
                            this.nextStep();
                        }
                    } else if (e.key === 'ArrowLeft') {
                        if (this.currentStep > 0) {
                            this.previousStep();
                        }
                    }
                });
            }

            createOverlay() {
                this.overlay = document.createElement('div');
                this.overlay.className = 'tutorial-overlay';
                document.body.appendChild(this.overlay);
                this.overlay.style.display = 'block';
            }

            showStep(index) {
                const step = this.steps[index];
                const target = document.querySelector(step.target);
                
                if (!target) {
                    console.error(`Tutorial target not found: ${step.target}`);
                    this.complete();
                    return;
                }

                if (this.box) {
                    this.box.style.opacity = '0';
                    setTimeout(() => {
                        this.box.remove();
                        this.createNewBox(step, target);
                    }, 300); // Match transition duration
                } else {
                    this.createNewBox(step, target);
                }

                // Remove previous highlights
                document.querySelectorAll('.highlight-element').forEach(el => {
                    el.classList.remove('highlight-element');
                });

                target.classList.add('highlight-element');
                
                // Scroll target into view smoothly with offset
                const offset = window.innerHeight / 3;
                const targetPosition = target.getBoundingClientRect().top + window.pageYOffset - offset;
                
                window.scrollTo({
                    top: targetPosition,
                    behavior: 'smooth'
                });
            }

            createNewBox(step, target) {
                this.box = document.createElement('div');
                this.box.className = 'tutorial-box';
                this.box.style.opacity = '0'; // Start invisible
                this.box.innerHTML = `
                    <div>${step.content}</div>
                    <div class="tutorial-buttons" style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end;">
                        ${this.currentStep > 0 ? '<button class="tutorial-prev" title="Previous"><i class="fas fa-arrow-left"></i></button>' : ''}
                        ${this.currentStep < this.steps.length - 1 ? 
                            '<button class="tutorial-next" title="Next"><i class="fas fa-arrow-right"></i></button>' : 
                            '<button class="tutorial-complete" title="Complete"><i class="fas fa-check"></i></button>'}
                        <button class="tutorial-skip" title="Skip Tutorial">Skip</button>
                    </div>
                `;

                document.body.appendChild(this.box);
                
                // Position box then fade in
                this.positionBox(step, target);
                requestAnimationFrame(() => {
                    this.box.style.opacity = '1';
                });
                
                this.addButtonListeners();
            }

            positionBox(step, target) {
                const targetRect = target.getBoundingClientRect();
                const boxRect = this.box.getBoundingClientRect();
                const margin = 15;
                
                let left, top;
                
                switch(step.position) {
                    case 'right':
                        left = targetRect.right + margin;
                        top = targetRect.top;
                        if (left + boxRect.width > window.innerWidth - margin) {
                            left = window.innerWidth - boxRect.width - margin;
                        }
                        break;
                    case 'left':
                        left = targetRect.left - boxRect.width - margin;
                        top = targetRect.top;
                        break;
                    case 'up':
                        left = targetRect.left;
                        top = targetRect.top - boxRect.height - margin;
                        break;
                    case 'down':
                        left = targetRect.left;
                        top = targetRect.bottom + margin;
                        break;
                    default:
                        left = targetRect.right + margin;
                        top = targetRect.top;
                }

                // Viewport boundaries
                const viewport = {
                    left: 20,
                    right: window.innerWidth - 20,
                    top: 20,
                    bottom: window.innerHeight - 20
                };

                // Adjust positions
                if (left < viewport.left) left = viewport.left;
                if (left + boxRect.width > viewport.right) left = viewport.right - boxRect.width;
                if (top < viewport.top) top = viewport.top;
                if (top + boxRect.height > viewport.bottom) top = viewport.bottom - boxRect.height;

                // Apply position with smooth transition
                this.box.style.transform = 'translate3d(0, 0, 0)'; // Enable hardware acceleration
                this.box.style.left = `${left}px`;
                this.box.style.top = `${top}px`;
            }

            addButtonListeners() {
                const prevBtn = this.box.querySelector('.tutorial-prev');
                const nextBtn = this.box.querySelector('.tutorial-next');
                const completeBtn = this.box.querySelector('.tutorial-complete');
                const skipBtn = this.box.querySelector('.tutorial-skip');

                if (prevBtn) {
                    prevBtn.addEventListener('click', () => this.previousStep());
                }
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => this.nextStep());
                }
                if (completeBtn) {
                    completeBtn.addEventListener('click', () => this.complete());
                }
                if (skipBtn) {
                    skipBtn.addEventListener('click', () => this.complete());
                }
            }

            previousStep() {
                if (this.currentStep > 0) {
                    document.querySelector(this.steps[this.currentStep].target)
                        .classList.remove('highlight-element');
                    this.currentStep--;
                    this.showStep(this.currentStep);
                }
            }

            nextStep() {
                if (this.currentStep < this.steps.length - 1) {
                    document.querySelector(this.steps[this.currentStep].target)
                        .classList.remove('highlight-element');
                    this.currentStep++;
                    this.showStep(this.currentStep);
                }
            }

            complete() {
                localStorage.setItem('tutorialComplete', 'true');
                if (this.box) {
                    this.box.remove();
                }
                if (this.overlay) {
                    this.overlay.remove();
                }
                document.querySelectorAll('.highlight-element')
                    .forEach(el => el.classList.remove('highlight-element'));
            }
        }

        // Initialize tutorial when page loads
        window.addEventListener('load', () => {
            new Tutorial(tutorialSteps);
        });

        // Error Popup Functions
        function showErrorPopup(message) {
            errorMessage.textContent = message;
            errorPopup.classList.add('active');
        }

        function hideErrorPopup() {
            errorPopup.classList.remove('active');
        }

        // Helper function to set caret at end of contenteditable element
        function setCaretAtEnd(el) {
            el.focus();
            if (typeof window.getSelection != "undefined"
                && typeof document.createRange != "undefined") {
                const range = document.createRange();
                range.selectNodeContents(el);
                range.collapse(false);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            }
        }

        // Graphs Implementation using Chart.js
        function updateGraphs() {
            // Get performance stats
            const tp = parseFloat(document.getElementById('tp_result').textContent) || 0;
            const sp = parseFloat(document.getElementById('sp_result').textContent) || 0;
            const go = parseFloat(document.getElementById('gos_result').textContent) || 0;
            const ad = parseFloat(document.getElementById('ad_result').textContent) || 0;
            const xpr = parseFloat(document.getElementById('xpr_result').textContent) || 0;

            // Get the canvas context
            const ctx = document.getElementById('performanceChart').getContext('2d');

            const data = {
                labels: ['Tactical Performance (TP)', 'Special Performance (SP)', 'Guard Objective Score (GO)', 'Average Damage (AD)', 'XP per Round (XPR)'],
                datasets: [{
                    data: [tp, sp, go, ad, xpr],
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.6)',
                        'rgba(255, 99, 132, 0.6)',
                        'rgba(255, 206, 86, 0.6)',
                        'rgba(54, 162, 235, 0.6)',
                        'rgba(153, 102, 255, 0.6)'
                    ],
                    borderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(153, 102, 255, 1)'
                    ],
                    borderWidth: 1,
                    hoverOffset: 4
                }]
            };

            const options = {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: '#72767d'
                        }
                    },
                    tooltip: {
                        enabled: true,
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.parsed}`;
                            }
                        }
                    }
                },
                scales: {
                    r: {
                        angleLines: {
                            color: '#72767d'
                        },
                        grid: {
                            color: '#72767d'
                        },
                        ticks: {
                            color: '#72767d',
                            backdropColor: 'transparent'
                        }
                    }
                }
            };

            // If chart exists, destroy it before creating a new one
            if (performanceChart) {
                performanceChart.destroy();
            }

            // Create new Polar Area chart
            performanceChart = new Chart(ctx, {
                type: 'polarArea',
                data: data,
                options: options
            });
        }

        // Tooltip Functions (for custom tooltips if needed)
        function showTooltip(event, text) {
            tooltip.textContent = text;
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY + 10) + 'px';
            tooltip.style.opacity = '1';
        }

        function moveTooltip(event) {
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY + 10) + 'px';
        }

        function hideTooltip() {
            tooltip.style.opacity = '0';
        }
    </script>
</body></html>
